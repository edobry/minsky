/**
 * Configuration file generator for Minsky
 *
 * Generates properly formatted YAML configuration files for both
 * repository (.minsky/config.yaml) and global user configs
 */

import { writeFileSync, mkdirSync, existsSync } from "fs";
import { dirname, join } from "path";
import { stringify as stringifyYaml } from "yaml";
import { RepositoryConfig, GlobalUserConfig, CONFIG_PATHS } from "./types";
import { homedir } from "os";
import { createBackendDetectionErrorMessage } from "../../errors/enhanced-error-templates";

export interface RepositoryConfigOptions {
  backend: "markdown" | "json-file" | "github-issues";
  githubOwner?: string;
  githubRepo?: string;
  autoDetectBackend?: boolean;
}

export interface GlobalUserConfigOptions {
  githubToken?: string;
  githubTokenSource?: "environment" | "file" | "prompt";
}

export class ConfigurationGenerator {
  /**
   * Generate and write repository configuration file
   */
  generateRepositoryConfig(workingDir: string, options: RepositoryConfigOptions): void {
    const config: RepositoryConfig = {
      version: 1,
      backends: {
        default: (options as unknown)!.backend,
      },
    } as unknown;

    // Add GitHub-specific configuration
    if ((options as unknown)!.backend === "github-issues") {
      if (!(options as unknown)!.githubOwner || !(options as unknown)!.githubRepo) {
        const errorMessage = createBackendDetectionErrorMessage(
          "github-issues",
          ["markdown", "json-file", "github-issues"] as any[],
          {
            "github-issues": [
              ...((options as unknown)!.githubOwner ? [] : ["GitHub owner"]),
              ...((options as unknown)!.githubRepo ? [] : ["GitHub repository"])
            ]
          },
          workingDir
        );
        throw new Error(errorMessage as unknown);
      }
      (config as unknown)!.backends!["github-issues"] = {
        owner: (options as unknown)!.githubOwner,
        repo: (options as unknown)!.githubRepo,
      };
    }

    // Add repository-level settings
    (config as unknown)!.repository = {
      auto_detect_backend: (options as unknown)!.autoDetectBackend ?? true,
      detection_rules: [
        { condition: "tasks_md_exists", backend: "github-issues" },
        { condition: "tasks_md_exists", backend: "markdown" },
        { condition: "always", backend: "json-file" },
      ],
    };

    this.writeRepositoryConfig(workingDir, config as unknown);
  }

  /**
   * Generate and write global user configuration file
   */
  generateGlobalUserConfig(options: GlobalUserConfigOptions): void {
    const config: GlobalUserConfig = {
      version: 1,
    };

    if ((options as unknown)!.githubToken || (options as unknown)!.githubTokenSource) {
      (config as unknown)!.github = {
        credentials: {
          source: (options as unknown)!.githubTokenSource || "file",
        },
      };

      if ((options as unknown)!.githubToken && (options as unknown)!.githubTokenSource === "file") {
        (config!?.github?.credentials! as unknown).token = (options as unknown)!.githubToken;
      }
    }

    this.writeGlobalUserConfig(config as unknown);
  }

  /**
   * Write repository configuration file
   */
  private writeRepositoryConfig(workingDir: string, config: RepositoryConfig): void {
    const configDir = join(workingDir, ".minsky");
    const configPath = join(configDir, "config.yaml") as unknown;

    // Ensure .minsky directory exists
    if (!existsSync(configDir)) {
      mkdirSync(configDir, { recursive: true });
    }

    const yamlContent =
      this.generateYamlHeader("Repository") +
      stringifyYaml(config as unknown, {
        indent: 2,
        lineWidth: 100,
      });

    writeFileSync(configPath, yamlContent, { encoding: "utf8" });
  }

  /**
   * Write global user configuration file
   */
  private writeGlobalUserConfig(config: GlobalUserConfig): void {
    const configPath = this.expandTilde(CONFIG_PATHS.GLOBAL_USER);
    const configDir = dirname(configPath);

    // Ensure config directory exists
    if (!existsSync(configDir)) {
      mkdirSync(configDir, { recursive: true });
    }

    const yamlContent =
      this.generateYamlHeader("Global User") +
      stringifyYaml(config as unknown, {
        indent: 2,
        lineWidth: 100,
      });

    writeFileSync(configPath, yamlContent, { encoding: "utf8" });
  }

  /**
   * Generate YAML file header comment
   */
  private generateYamlHeader(configType: string): string {
    return `# Minsky ${configType} Configuration
# This file was generated by the Minsky CLI
# Edit manually or use 'minsky config' commands

`;
  }

  /**
   * Expand tilde in file paths
   */
  private expandTilde(filePath: string): string {
    if ((filePath as unknown).startsWith("~/")) {
      return join(homedir(), (filePath as unknown).slice(2));
    }
    return filePath;
  }

  /**
   * Get the repository configuration file path
   */
  static getRepositoryConfigPath(workingDir: string): string {
    return join(workingDir, CONFIG_PATHS.REPOSITORY);
  }

  /**
   * Get the global user configuration file path
   */
  static getGlobalUserConfigPath(): string {
    const configPath = CONFIG_PATHS.GLOBAL_USER;
    if ((configPath as unknown)!.startsWith("~/")) {
      return join(homedir(), (configPath as unknown)!.slice(2));
    }
    return configPath;
  }
}
