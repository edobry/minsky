# Self-Improvement Protocol

## Critical Compliance Failures Identified

### 1. Tool Selection Violations
**Pattern**: Using regular tools instead of session-specific tools in session workspaces
**Examples**:
- Using `search_replace` instead of `mcp_minsky-server_session_search_replace`
- Using `read` instead of `mcp_minsky-server_session_read_file`
- Using `edit_file` instead of `mcp_minsky-server_session_edit_file`

**Fix**: MANDATORY workspace detection and tool selection enforcement

### 2. Edit Format Violations
**Pattern**: Using `session_edit_file` without required `// ... existing code ...` delimiters
**Impact**: Edits fail or produce incorrect results
**Fix**: Always include context delimiters for surgical edits

### 3. Resource Management Violations
**Pattern**: Creating documentation/rules with wrong tools
**Examples**:
- Using `session_write_file` (doesn't exist) instead of `mcp_minsky-server_session_write_file`
- Should use `mcp_minsky-server_rules_create` for rule files

## Systematic Test Fixing Methodology

### Architecture Pattern Recognition
1. **Mock API Compatibility**: Ensure mock objects provide all methods the code expects
2. **Dependency Injection**: Use modern command functions that accept injected dependencies
3. **Mock Completeness**: Mock all methods that might be called, not just asserted ones
4. **Correct Expectations**: Align test assertions with actual return types

### Test File Analysis Framework
1. **Error Categorization**: Group similar errors for batch fixing
2. **Import Path Updates**: Modern vs legacy function imports
3. **Mock Function Standardization**: Use `createMock()` consistently
4. **Git Service Mocking**: Prevent real git operations in tests

## Enforcement Mechanisms Added

### Updated workspace-verification Rule
- Added MANDATORY session tool detection
- Automatic tool selection based on workspace path
- Required edit format enforcement
- Zero tolerance for protocol violations

### Behavioral Changes Required
- Pre-action workspace verification
- Tool selection validation
- Edit format compliance
- Resource management protocol adherence

## Success Metrics
- 0 ESLint violations achieved
- Test failure reduction from 127 to manageable categories
- Architectural improvements applied systematically
- Protocol violations eliminated through rule updates
