<!-- Generated by SpecStory -->

# Enhancing Minsky CLI: Task ID for Session Start (2025-04-27 15:26:44)

_**User**_

update the session start command to optionally take a task id instead of a session name, and then look up the task details and associate it with the new session. use the task id as a session name, something like "<repo>/task#001". the session should have a full name (including the repo) and a short name (without the repo, which is used for the branch name).  summarize what i said, contextualize it in reference to the minsky project, analyze whether this makes sense with the broader design, and then propose a plan of action

---

_**Assistant**_

**Summary of Your Request**

You want to update the Minsky CLI's session start command so that it can optionally accept a task ID (e.g., `001`) instead of a session name. When a task ID is provided, the CLI should:
- Look up the task details (presumably from your `/process/tasks.md` and/or `/process/tasks/{id}-*.md` files).
- Use the task ID as the session name, formatted as `<repo>/task#001` for the full name.
- The session should have both a "full name" (including the repo, e.g., `minsky/task#001`) and a "short name" (just `task#001`, used for the git branch name).
- The session should be associated with the looked-up task details.

**Contextualization in the Minsky Project**

- Minsky is a CLI tool for managing collaborative AI agent workflows, with a strong focus on task-driven development and traceability.
- Tasks are tracked in `/process/tasks.md` and detailed in `/process/tasks/{id}-*.md`.
- Sessions represent collaborative or individual work contexts, often mapped to git branches.
- Associating sessions with tasks (by ID) aligns with the project's emphasis on traceability, process discipline, and automation.

**Analysis: Does This Make Sense with the Broader Design?**

- **Yes, this fits well.**  
  - It strengthens the link between code, process, and task management, which is a core Minsky principle.
  - Using the task ID as the session/branch name improves traceability and enforces process discipline.
  - Looking up and associating task details with the session enables richer automation (e.g., auto-filling PR templates, changelog entries, etc.).
  - The dual naming (full and short) is practical for both human readability and git workflow integration.

**Potential Considerations**
- The CLI must robustly parse and validate task IDs.
- Task lookup should handle missing or malformed task specs gracefully.
- The session metadata should be updated to store the association with the task (for later automation).
- Backward compatibility: the command should still accept a freeform session name if a task ID is not provided.

---

**Proposed Plan of Action**

1. **Update CLI Command Signature**
   - Modify the `session start` command to accept either a session name or a task ID (with a flag or by auto-detecting numeric input).

2. **Task Lookup Logic**
   - Implement logic to:
     - Parse the task ID.
     - Look up the task in `/process/tasks.md` and load its details from `/process/tasks/{id}-*.md`.
     - Handle errors if the task does not exist.

3. **Session Naming**
   - If a task ID is provided:
     - Set the session's full name as `<repo>/task#{id}`.
     - Set the short name as `task#{id}` (for branch naming).
   - If a session name is provided, use the existing logic.

4. **Session Metadata Update**
   - Store the association between the session and the task details in the session metadata (e.g., in a `.minsky/session.json` or similar).

5. **Backward Compatibility**
   - Ensure the command still works with freeform session names.

6. **Testing**
   - Add/modify tests to cover:
     - Starting a session with a task ID.
     - Starting a session with a freeform name.
     - Error handling for invalid/missing task IDs.

7. **Documentation**
   - Update CLI help and project documentation to describe the new behavior.

---

Would you like to proceed with this plan, or do you want to adjust any part of it before implementation?

---

_**User**_

is there any ambiguity in this spec? are there any details that need fleshing out, any questions i could answer?


---

_**Assistant**_

Your spec is clear and well-aligned with the Minsky project's goals, but there are a few areas where additional detail or clarification could help ensure a smooth implementation and robust user experience:

---

### 1. **How Should the CLI Distinguish Between a Task ID and a Session Name?**
- Should the user explicitly specify a flag (e.g., `--task 001`) or should the CLI infer from the input format (e.g., if the argument is numeric or matches a pattern like `task#001`)?
- What if a session name could look like a task ID? (e.g., someone wants a session called "001" for another reason)

**Suggestion:**  
Explicit flags (`--task 001`) are less ambiguous and more future-proof.

---

### 2. **What Task Details Should Be Associated with the Session?**
- Should the session metadata include just the task ID, or also the full task title, description, checklist, etc.?
- Should the session "lock in" a snapshot of the task details at creation, or always reference the latest version of the task spec?

**Suggestion:**  
Store at least the task ID and title in the session metadata. Consider referencing the file path for dynamic lookup, but snapshotting key details (title, description) can help with traceability if tasks change over time.

---

### 3. **What If the Task ID Does Not Exist?**
- Should the CLI error out, prompt to create a new task, or allow session creation without a valid task association?

**Suggestion:**  
Fail with a clear error if the task ID does not exist, and suggest how to create a new task.

---

### 4. **Session Naming and Branch Naming**
- Should the branch name always be `task#001`, or should it be customizable (e.g., `task#001-some-keyword`)?
- Should the CLI enforce a naming convention for branches associated with tasks?

**Suggestion:**  
Default to `task#001`, but allow an optional suffix for clarity (e.g., `task#001-fix-bug`). Enforce a consistent prefix for traceability.

---

### 5. **Multiple Tasks per Session?**
- Is it possible for a session to be associated with more than one task, or is it strictly one-to-one?

**Suggestion:**  
Start with one-to-one for simplicity, but design the metadata to allow for future extension.

---

### 6. **Where Is the Session Metadata Stored?**
- Is there a canonical location for session metadata (e.g., `.minsky/session.json` in the repo root)?
- Should this metadata be committed to git, or is it local-only?

**Suggestion:**  
Clarify the storage location and versioning/commit policy.

---

### 7. **User Experience and Error Handling**
- What should the CLI output if the user tries to start a session for a task that already has an active session?
- Should the CLI prompt to switch, merge, or abort?

---

### 8. **Task Lookup Source of Truth**
- Should the CLI always use `/process/tasks.md` as the index, or is it enough to look for `/process/tasks/{id}-*.md` files?
- How should it handle missing or malformed task files?

---

## Questions for You

1. **Flag or Pattern?**  
   Should the CLI require a `--task` flag, or infer from the argument?

2. **Metadata Details?**  
   What task details should be stored in the session metadata?

3. **Branch Naming?**  
   Should branch names be strictly `task#001`, or allow suffixes?

4. **Session Metadata Location?**  
   Where should session metadata be stored, and should it be committed?

5. **Multiple Tasks?**  
   Should sessions ever be associated with multiple tasks?

6. **Task Lookup Source?**  
   Should the CLI use `/process/tasks.md` as the index, or just the task files?

7. **Error Handling?**  
   What should happen if a task ID does not exist, or if a session for that task already exists?

---

If you clarify these points, the implementation can be more robust and aligned with your workflow!

---

_**User**_

1. the former

2. just task id

3. error

4. the former

5. single

6. didnt we already create a session db? look at the code

7. error and say that there's already an active session, return the name

8. we dont need to specify this here, reuse the tasks domain module here which manages this logic.


go ahead and create a new task containing a full specification, accounting for these details

---

_**Assistant**_

<details>
            <summary>Searched codebase "session db" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/domain/session.ts` | L9-57 |
| `src/commands/session/get.ts` | L1-17 |
| `src/commands/session/list.ts` | L1-18 |
| `src/domain/session.ts` | L1-9 |
| `src/domain/repo-utils.ts` | L1-9 |
| `src/domain/repo-utils.ts` | L9-26 |
| `src/commands/session/start.ts` | L1-60 |
| `src/commands/session/index.ts` | L1-17 |
| `src/domain/tasks.ts` | L1-14 |
| `src/domain/repo-utils.test.ts` | L1-26 |
| `src/domain/git.ts` | L1-11 |
| `src/domain/git.ts` | L53-71 |
| `src/cli.ts` | L20-21 |
| `src/commands/git/clone.ts` | L1-26 |
| `.cursor/rules/derived-cursor-rules.mdc` | L1-257 |
| `src/commands/session/cd.ts` | L1-13 |
| `src/domain/git.ts` | L49-53 |
| `README.md` | L1-148 |
| `src/commands/session/start.ts` | L60-73 |
| `src/commands/git/pr.ts` | L1-51 |
| `src/domain/git.ts` | L16-21 |
| `src/domain/git.ts` | L11-16 |
| `src/domain/git.ts` | L71-82 |
| `src/domain/git.ts` | L26-33 |
| `src/cli.ts` | L1-11 |

</details>

---

Here is a new task specification for updating the Minsky CLI session start command to support task IDs, fully accounting for your clarifications and the current codebase:

---

# Task: Update `session start` Command to Support Task IDs

## Objective

Enhance the `minsky session start` command so that it can optionally accept a task ID (instead of a session name), look up the task details, and associate the session with the task. The session should use the task ID as its name (e.g., `task#001`), and store the association in the session database.

---

## Requirements

1. **CLI Behavior**
   - The command signature should be:
     ```
     minsky session start <session-name> --repo <repo-url-or-path> [--task <task-id>]
     ```
   - If `--task <task-id>` is provided:
     - Use the task ID as the session name (e.g., `task#001`).
     - Look up the task using the tasks domain module.
     - If the task does not exist, error out with a clear message.
     - If a session for this task already exists, error out and return the session name.
   - If `--task` is not provided, use the given `<session-name>` as before.

2. **Session Naming**
   - The session should have:
     - A full name: `<repo>/task#001`
     - A short name: `task#001` (used for the git branch)
   - Store the session using the short name in the session DB for consistency with existing logic.

3. **Session Database**
   - Continue using the existing `SessionDB` in `src/domain/session.ts`.
   - Store the task ID in the session record if the session is associated with a task.
   - Only store the task ID (not a snapshot of the task details).

4. **Task Lookup**
   - Use the existing tasks domain module for all task lookups and validation.
   - Do not duplicate task parsing logic in the command module.

5. **Single Task per Session**
   - Each session may only be associated with a single task.

6. **Error Handling**
   - If the task ID does not exist, error out.
   - If a session for the task already exists, error out and return the session name.
   - If the session name is already in use, error out as before.

7. **Backward Compatibility**
   - The command must continue to support starting a session with a freeform session name (without `--task`).

8. **Testing**
   - Add/modify tests to cover:
     - Starting a session with a task ID.
     - Starting a session with a freeform name.
     - Error handling for invalid/missing task IDs.
     - Error handling for duplicate sessions.

9. **Documentation**
   - Update CLI help and project documentation to describe the new behavior.

---

## Implementation Steps

1. Update the `session start` command in `src/commands/session/start.ts`:
   - Add a `--task <task-id>` option.
   - If `--task` is provided, use the task ID as the session name and perform task lookup.
   - Validate that the task exists and that no session for this task already exists.
   - Store the task ID in the session record.

2. Update the `SessionRecord` type in `src/domain/session.ts` to include an optional `taskId` field.

3. Update the session creation logic to use the short name (`task#001`) for the branch and session DB.

4. Ensure all error cases are handled as specified.

5. Update or add tests for the new behavior.

6. Update documentation and CLI help output.

---

## Verification

- [ ] Can start a session with a freeform name as before.
- [ ] Can start a session with `--task <task-id>`, and the session is named after the task.
- [ ] If the task does not exist, the command errors out with a clear message.
- [ ] If a session for the task already exists, the command errors out and returns the session name.
- [ ] The session DB record includes the `taskId` if the session is associated with a task.
- [ ] All relevant tests pass.
- [ ] Documentation and CLI help are updated.

---

## Notes

- The tasks domain module is the single source of truth for task lookup and validation.
- The session DB is the single source of truth for session existence and metadata.
- This change maintains backward compatibility and enforces a one-to-one mapping between sessions and tasks when using `--task`.

---

Would you like to proceed with implementation based on this specification?

---

_**User**_

go ahead and create a new task

---

_**Assistant**_

<details>
            <summary>Listed directory process • **3** results</summary>
        
| Name |
|-------|
| 📄 `tasks.md` |
| 📄 `README.md` |
| 📁 `tasks` |

</details>

---

<details>
            <summary>Listed directory process/tasks • **0** results</summary>
        
No results found
</details>

---

Read file: process/tasks.md

---

```diff
  
  ## Tasks
+ 
+ - [ ] Update session start command to support task IDs [#001](tasks/001-update-session-start-task-id.md)
  
```

---

```diff
- 
+ # Task #001: Update `session start` Command to Support Task IDs
+ 
+ ## Context
+ 
+ The Minsky CLI manages collaborative AI agent workflows using sessions and tasks. Currently, the `session start` command requires a session name. To improve traceability and workflow integration, the command should optionally accept a task ID, look up the task, and associate the session with it. This will allow sessions to be directly linked to tracked work items.
+ 
+ ## Requirements
+ 
+ 1. **CLI Behavior**
+    - Command signature:
+      ```
+      minsky session start <session-name> --repo <repo-url-or-path> [--task <task-id>]
+      ```
+    - If `--task <task-id>` is provided:
+      - Use the task ID as the session name (e.g., `task#001`).
+      - Look up the task using the tasks domain module.
+      - If the task does not exist, error out with a clear message.
+      - If a session for this task already exists, error out and return the session name.
+    - If `--task` is not provided, use the given `<session-name>` as before.
+ 
+ 2. **Session Naming**
+    - The session should have:
+      - A full name: `<repo>/task#001`
+      - A short name: `task#001` (used for the git branch)
+    - Store the session using the short name in the session DB for consistency with existing logic.
+ 
+ 3. **Session Database**
+    - Continue using the existing `SessionDB` in `src/domain/session.ts`.
+    - Store the task ID in the session record if the session is associated with a task.
+    - Only store the task ID (not a snapshot of the task details).
+ 
+ 4. **Task Lookup**
+    - Use the existing tasks domain module for all task lookups and validation.
+    - Do not duplicate task parsing logic in the command module.
+ 
+ 5. **Single Task per Session**
+    - Each session may only be associated with a single task.
+ 
+ 6. **Error Handling**
+    - If the task ID does not exist, error out.
+    - If a session for the task already exists, error out and return the session name.
+    - If the session name is already in use, error out as before.
+ 
+ 7. **Backward Compatibility**
+    - The command must continue to support starting a session with a freeform session name (without `--task`).
+ 
+ 8. **Testing**
+    - Add/modify tests to cover:
+      - Starting a session with a task ID.
+      - Starting a session with a freeform name.
+      - Error handling for invalid/missing task IDs.
+      - Error handling for duplicate sessions.
+ 
+ 9. **Documentation**
+    - Update CLI help and project documentation to describe the new behavior.
+ 
+ ## Implementation Steps
+ 
+ 1. Update the `session start` command in `src/commands/session/start.ts`:
+    - Add a `--task <task-id>` option.
+    - If `--task` is provided, use the task ID as the session name and perform task lookup.
+    - Validate that the task exists and that no session for this task already exists.
+    - Store the task ID in the session record.
+ 
+ 2. Update the `SessionRecord` type in `src/domain/session.ts` to include an optional `taskId` field.
+ 
+ 3. Update the session creation logic to use the short name (`task#001`) for the branch and session DB.
+ 
+ 4. Ensure all error cases are handled as specified.
+ 
+ 5. Update or add tests for the new behavior.
+ 
+ 6. Update documentation and CLI help output.
+ 
+ ## Verification
+ 
+ - [ ] Can start a session with a freeform name as before.
+ - [ ] Can start a session with `--task <task-id>`, and the session is named after the task.
+ - [ ] If the task does not exist, the command errors out with a clear message.
+ - [ ] If a session for the task already exists, the command errors out and returns the session name.
+ - [ ] The session DB record includes the `taskId` if the session is associated with a task.
+ - [ ] All relevant tests pass.
+ - [ ] Documentation and CLI help are updated.
+ 
+ ## Notes
+ 
+ - The tasks domain module is the single source of truth for task lookup and validation.
+ - The session DB is the single source of truth for session existence and metadata.
+ - This change maintains backward compatibility and enforces a one-to-one mapping between sessions and tasks when using `--task`. 
+ 
```

---

A new task has been created:

- **Added to `process/tasks.md`:**
  - `- [ ] Update session start command to support task IDs [#001](tasks/001-update-session-start-task-id.md)`

- **Created detailed spec:**  
  - `process/tasks/001-update-session-start-task-id.md`  
    This file contains a full context, requirements, implementation steps, and verification checklist for updating the `session start` command to support task IDs, as specified in your instructions.

Let me know if you want to proceed with implementation or need any adjustments to the task description!

---

_**User**_

i want the session db entry to contain the repo name. i also want repos to be stored under a per-repo directory, so the full path to the session repo looks like "/Users/edobry/.local/state/minsky/git/<repo>/test-session-1", similar to the "session full name" concept we introduced

---

_**Assistant**_

<details>
            <summary>Searched codebase "SessionDB addSession" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/domain/session.ts` | L9-57 |
| `src/domain/session.ts` | L1-9 |
| `src/commands/session/get.ts` | L1-17 |
| `src/commands/session/list.ts` | L1-18 |
| `src/commands/session/index.ts` | L1-17 |
| `src/commands/session/start.ts` | L1-60 |
| `src/cli.ts` | L20-21 |
| `src/domain/repo-utils.ts` | L1-9 |
| `src/domain/tasks.ts` | L1-14 |
| `src/domain/repo-utils.ts` | L9-26 |
| `src/commands/git/clone.ts` | L1-26 |
| `src/domain/git.ts` | L53-71 |
| `src/commands/session/start.ts` | L60-73 |
| `src/domain/git.ts` | L49-53 |
| `src/domain/git.ts` | L1-11 |
| `src/commands/session/cd.ts` | L1-13 |
| `src/commands/git/pr.ts` | L1-51 |
| `src/domain/repo-utils.test.ts` | L1-26 |
| `src/commands/git/branch.ts` | L1-23 |
| `src/domain/git.ts` | L11-16 |
| `src/domain/git.ts` | L16-21 |
| `src/domain/git.ts` | L71-82 |
| `src/domain/git.ts` | L26-33 |
| `.cursor/rules/derived-cursor-rules.mdc` | L1-257 |
| `src/commands/tasks/status.ts` | L35-71 |

</details>

---

Here’s a summary and plan for the changes you want:

---

## Summary of Your Request

- **Session DB**: You want each session record to include the repo name (not just the URL).
- **Repo Storage**: You want session repos to be stored under a per-repo directory, so the path is:
  ```
  /Users/edobry/.local/state/minsky/git/<repo>/<session>
  ```
  (where `<repo>` is a normalized name, e.g., `github.com-org-project` or similar, not a raw URL).
- **Session Full Name**: This matches the “session full name” concept, e.g., `minsky/task#001` (full) and `task#001` (short).

---

## Analysis

- **SessionRecord** in `src/domain/session.ts` currently does not include a `repoName` field.
- The repo storage path is currently just `.../git/<session>`, not grouped by repo.
- The `GitService` and session commands will need to be updated to:
  - Normalize and store the repo name (e.g., from URL or local path).
  - Use this normalized name for both the session DB and the directory structure.
- All commands that resolve or display session paths will need to use the new structure.

---

## Plan of Action

1. **Update SessionRecord**
   - Add a `repoName` field to `SessionRecord` in `src/domain/session.ts`.

2. **Repo Name Normalization**
   - Implement a utility to normalize repo URLs/paths into a safe directory name (e.g., `github.com-org-project`).
   - Use this normalized name for both storage and the session DB.

3. **Update GitService**
   - Change the base directory logic in `GitService` to use `.../git/<repo>/<session>`.

4. **Update Session Creation**
   - When starting a session, extract and store the normalized repo name.
   - Store it in the session DB entry.

5. **Update Session Path Resolution**
   - Update all code that computes the session workdir (e.g., `session cd`, `git branch`, etc.) to use the new path structure.

6. **Backward Compatibility**
   - Consider migration or fallback for existing sessions (optional, depending on project maturity).

7. **Testing**
   - Update/add tests to verify:
     - Sessions are stored under the correct per-repo directory.
     - Session DB entries include the correct repo name.
     - All commands work with the new structure.

8. **Documentation**
   - Update documentation to reflect the new session storage structure and DB schema.

---

Would you like to proceed with this plan, or do you want to clarify the repo name normalization format before implementation? (e.g., should it be `github.com-org-project`, `org-project`, or something else?)

---

_**User**_

we dont need backward compatibility, just migrate extant session records

for the normalized name, lets use org/project, and if the repo is a local path, use "local" for the org perhaps, unless you have a better idea

---

_**Assistant**_

Great, here’s a refined plan based on your clarifications:

---

## Finalized Plan

### 1. **SessionRecord Update**
- Add a `repoName` field (string, e.g., `org/project` or `local/project`) to `SessionRecord` in `src/domain/session.ts`.

### 2. **Repo Name Normalization**
- For remote URLs:  
  - Extract the org and project (e.g., `github.com/org/project.git` → `org/project`).
- For local paths:  
  - Use `local/<basename-of-path>` (e.g., `/Users/edobry/Projects/minsky` → `local/minsky`).

### 3. **Directory Structure**
- Store session repos under:  
  ```
  $XDG_STATE_HOME/minsky/git/<repoName>/<session>
  ```
  Example:  
  ```
  .../minsky/git/org/project/test-session-1
  .../minsky/git/local/minsky/test-session-2
  ```

### 4. **Session DB Migration**
- On next run, migrate any existing session records to include the new `repoName` field and update their workdir if needed.

### 5. **Update All Logic**
- All session creation, lookup, and path resolution must use the new per-repo directory structure and `repoName` field.

### 6. **Testing**
- Ensure all commands (start, cd, branch, pr, etc.) work with the new structure.
- Add/modify tests to verify correct repo grouping and DB schema.

### 7. **Documentation**
- Update documentation to describe the new session storage and DB schema.

---

**Repo Name Normalization Details:**
- For remote:  
  - Parse the URL, extract org and project, strip `.git` if present.
  - Example: `https://github.com/org/project.git` → `org/project`
- For local:  
  - Use `local/<basename>`, where `<basename>` is the last segment of the path.

---

**If you’re happy with this plan, I’ll proceed to:**
- Update the task spec to reflect these details.
- Begin implementation (if requested).

Would you like to proceed? Any tweaks to the normalization logic?

---

_**User**_

create a new task with this spec

---

_**Assistant**_

```diff
  
  - [ ] Update session start command to support task IDs [#001](tasks/001-update-session-start-task-id.md)
+ - [ ] Store session repos under per-repo directories and add repoName to session DB [#002](tasks/002-per-repo-session-storage.md)
  
```

---



---



---

