#!/usr/bin/env sh

echo "🔒 SECURITY: Scanning for secrets (CRITICAL - MUST RUN FIRST)..."

# SECURITY: Secret scanning with gitleaks (primary scanner)
echo "🔍 Running gitleaks scan..."
if command -v gitleaks >/dev/null 2>&1; then
    if ! gitleaks protect --staged --source . --verbose; then
        echo "❌ �� SECRETS DETECTED BY GITLEAKS! Commit blocked for security."
        echo "📋 Review the findings above and sanitize any real credentials."
        echo "💡 Use placeholder values like 'sk-proj-xxx...xxxxx' instead."
        exit 1
    fi
    echo "✅ Gitleaks: No secrets detected in staged changes."
else
    echo "⚠️  gitleaks not found. Install via: brew install gitleaks"
fi

# SECURITY: Additional secret scanning with secretlint (secondary scanner)
echo "🔍 Running secretlint scan..."
if command -v npx >/dev/null 2>&1; then
    if ! npx secretlint "**/*" --no-color 2>/dev/null; then
        echo "❌ 🚨 ADDITIONAL SECRETS DETECTED BY SECRETLINT! Commit blocked for security."
        echo "�� Review the findings above and sanitize any real credentials."
        exit 1
    fi
    echo "✅ Secretlint: No additional secrets detected."
else
    echo "⚠️  npx not available for secretlint."
fi

echo "✅ SECURITY: Secret scanning completed successfully."

echo "🔍 Checking for variable naming issues..."

# Run the variable naming checker
if ! bun run scripts/check-variable-naming.ts; then
  echo "❌ Variable naming issues found! Please fix them before committing."
  echo "💡 You can run 'bun run scripts/fix-variable-naming.ts' to auto-fix many issues."
  exit 1
fi

echo "✅ No variable naming issues found."

# Run linting (suppress warnings to reduce noise, only show errors)
echo "🔍 Running ESLint..."
if ! npm run lint -- --quiet; then
  echo "❌ Linting failed! Please fix the issues before committing."
  exit 1
fi

echo "✅ All checks passed! Commit proceeding..."
