#!/usr/bin/env sh

echo "ğŸ”’ SECURITY: Scanning for secrets (CRITICAL - MUST RUN FIRST)..."

# SECURITY: Secret scanning with gitleaks (primary scanner)
echo "ğŸ” Running gitleaks scan..."
if command -v gitleaks >/dev/null 2>&1; then
    if ! gitleaks protect --staged --source . --verbose; then
        echo "âŒ ï¿½ï¿½ SECRETS DETECTED BY GITLEAKS! Commit blocked for security."
        echo "ğŸ“‹ Review the findings above and sanitize any real credentials."
        echo "ğŸ’¡ Use placeholder values like 'sk-proj-xxx...xxxxx' instead."
        exit 1
    fi
    echo "âœ… Gitleaks: No secrets detected in staged changes."
else
    echo "âš ï¸  gitleaks not found. Install via: brew install gitleaks"
fi

# SECURITY: Additional secret scanning with secretlint (secondary scanner)
echo "ğŸ” Running secretlint scan..."
if command -v npx >/dev/null 2>&1; then
    if ! npx secretlint "**/*" --no-color 2>/dev/null; then
        echo "âŒ ğŸš¨ ADDITIONAL SECRETS DETECTED BY SECRETLINT! Commit blocked for security."
        echo "ï¿½ï¿½ Review the findings above and sanitize any real credentials."
        exit 1
    fi
    echo "âœ… Secretlint: No additional secrets detected."
else
    echo "âš ï¸  npx not available for secretlint."
fi

echo "âœ… SECURITY: Secret scanning completed successfully."

echo "ğŸ” Checking for variable naming issues..."

# Run the variable naming checker
if ! bun run scripts/check-variable-naming.ts; then
  echo "âŒ Variable naming issues found! Please fix them before committing."
  echo "ğŸ’¡ You can run 'bun run scripts/fix-variable-naming.ts' to auto-fix many issues."
  exit 1
fi

echo "âœ… No variable naming issues found."

# Run linting (suppress warnings to reduce noise, only show errors)
echo "ğŸ” Running ESLint..."
if ! npm run lint -- --quiet; then
  echo "âŒ Linting failed! Please fix the issues before committing."
  exit 1
fi

echo "âœ… All checks passed! Commit proceeding..."
